<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="socialplatform.backend.backend.mapper.LikeMapper">
    <resultMap id="BaseResultMap" type="socialplatform.backend.backend.model.Like">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="target_id" property="targetId"/>
        <result column="target_type" property="targetType"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <!--基础CRUD-->
    <insert id="insert" parameterType="socialplatform.backend.backend.model.Like" keyProperty="id" useGeneratedKeys="true">
        INSERT INTO `like`(
            user_id, target_id, target_type,create_time
        ) VALUES (
                     #{userId},#{targetId},#{targetType},NOW()
                 )
    </insert>
    <delete id="deleteByUserAndTarget">
        DELETE FROM `like`
        WHERE user_id = #{userId}
          AND target_id = #{targetId}
          AND target_type = #{targetType}
    </delete>
    <select id="existsLike" resultType="int">
        SELECT COUNT(*) FROM `like`
        WHERE user_id = #{userId}
          AND target_id = #{targetId}
          AND target_type = #{targetType}
    </select>
    <select id="countByTarget" resultType="int">
        SELECT COUNT(*) FROM `like`
        WHERE target_id = #{targetId}
          AND target_type = #{targetType}
    </select>

    <!--系统清理功能 -->
    <delete id="deleteByTarget">
        DELETE FROM `like`
        WHERE target_id = #{targetId}
          AND target_type = #{targetType}
    </delete>
    <delete id="deleteByUser">
        DELETE FROM `like`
        WHERE user_id = #{userId}
    </delete>

    <!--管理员统计功能-->
    <select id="selectHotArticles" resultType="map">
        SELECT
        a.id articleId,
        a.title,
        u.id as authorId,
        u.username as authorName,
        COUNT(l.id) as likeCount
        FROM article a
        JOIN `like` l ON a.id = l.target_id AND l.target_type = 1
        JOIN user u ON a.user_id = u.id
        WHERE a.status = 1
        GROUP BY a.id
        ORDER BY likeCount DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    <select id="countLikesTrend" resultType="map">
        SELECT
        DATE(create_time) as date,
        COUNT(*) as totalCount,
        SUM(IF(target_type = 1, 1, 0)) as articleLikes,
        SUM(IF(target_type = 2, 1, 0)) as commentLikes
        FROM `like`
        WHERE 1=1
        <if test="startDate != null and startDate != ''">
            AND create_time >= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND create_time &lt;= #{endDate}
        </if>
        GROUP BY DATE(create_time)
        ORDER BY date
    </select>

    <!--用户信息中心-->
    <select id="selectReceivedLikes" resultType="map">
        SELECT
            l.id as likeId,
            l.target_id as targetId,
            l.target_type as targetType,
            l.create_time,
            l.user_id as likerId,
            CASE
                WHEN l.target_type = 1 THEN a.title
                WHEN l.target_type = 2 THEN CONCAT('评论: ', LEFT(c.content, 30))
                END as targetContent
        FROM `like` l
                 LEFT JOIN article a ON l.target_type = 1 AND l.target_id = a.id
                 LEFT JOIN comment c ON l.target_type = 2 AND l.target_id = c.id
        WHERE
            (l.target_type = 1 AND a.user_id = #{userId})
           OR
            (l.target_type = 2 AND c.user_id = #{userId})
        ORDER BY l.create_time DESC
    </select>
</mapper>