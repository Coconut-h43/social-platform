<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="socialplatform.backend.backend.mapper.TagMapper">
    <resultMap id="TagResultMap" type="socialplatform.backend.backend.model.Tag">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="color" property="color"/>
        <result column="create_time" property="create_time"/>
        <result column="update_time" property="update_time"/>
    </resultMap>

    <!-- 管理员权限：基础CRUD -->
    <!-- 新增标签 -->
    <insert id="insert" parameterType="socialplatform.backend.backend.model.Tag" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tag (name, color, create_time, update_time)
        VALUES (#{name}, #{color}, NOW(), NOW())
    </insert>
    <!-- 根据ID删除标签 -->
    <delete id="deleteById">
        DELETE FROM tag WHERE id = #{id}
    </delete>
    <!-- 更新标签信息 -->
    <update id="updateTag" parameterType="socialplatform.backend.backend.model.Tag">
        UPDATE tag
        SET name = #{name},
            color = #{color},
            update_time = NOW()
        WHERE id = #{id}
    </update>
    <!-- 根据ID查询标签 -->
    <select id="selectById" resultMap="TagResultMap">
        SELECT * FROM tag WHERE id = #{id}
    </select>
    <!-- 根据创建时间查询标签 -->
    <select id="selectByCreateTime" resultMap="TagResultMap">
        SELECT * FROM tag
        WHERE DATE(create_time) = DATE(#{create_time})
        ORDER BY create_time DESC
    </select>
    <!-- 根据更新时间查询标签 -->
    <select id="selectByUpdateTime" resultMap="TagResultMap">
        SELECT * FROM tag
        WHERE DATE(update_time) = DATE(#{update_time})
        ORDER BY update_time DESC
    </select>

    <!-- 查询操作 -->
    <!-- 统计标签总数 -->
    <select id="count" resultType="int">
        SELECT COUNT(*) FROM tag
    </select>
    <!-- 分页查询标签 -->
    <select id="selectByPage" resultMap="TagResultMap">
        SELECT * FROM tag
        ORDER BY
        <choose>
            <when test="orderBy != null and orderBy != ''">
                ${orderBy}
            </when>
            <otherwise>
                create_time DESC
            </otherwise>
        </choose>
        LIMIT #{offset}, #{PageSize}
    </select>
    <!-- 关键词搜索标签 -->
    <select id="selectByKeyword" resultMap="TagResultMap">
        SELECT * FROM tag
        WHERE name LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY name
    </select>
    <!-- 按使用次数筛选 -->
    <!-- 按使用次数筛选 -->
    <select id="selectByUsageCount" resultMap="TagResultMap">
        SELECT t.*
        FROM tag t
                 LEFT JOIN article_tag at ON t.id = at.tag_id
        GROUP BY t.id
        HAVING COUNT(at.tag_id) >= #{minUsageCount}
        ORDER BY COUNT(at.tag_id) DESC
    </select>

    <!-- 标签的统计与展示 -->
    <!-- 获取热门标签 -->
    <select id="getHotTag" resultMap="TagResultMap">
        SELECT t.*
        FROM tag t
        LEFT JOIN article_tag at ON t.id = at.tag_id
        GROUP BY t.id
        ORDER BY COUNT(at.tag_id) DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>
    <!-- 获取所有标签 -->
    <select id="selectAll" resultMap="TagResultMap">
        SELECT * FROM tag ORDER BY create_time DESC
    </select>
    <!-- 获取所有标签（按名称排序） -->
    <select id="selectAllOrderByName" resultMap="TagResultMap">
        SELECT * FROM tag ORDER BY name
    </select>
    <!-- 获取标签使用次数 -->
    <select id="selectUsageCountById" resultType="Integer">
        SELECT COUNT(*)
        FROM article_tag
        WHERE tag_id = #{tagId}
    </select>

    <!-- 标签唯一性检验 -->
    <!-- 根据名称查询标签 -->
    <select id="selectByName" resultMap="TagResultMap">
        SELECT * FROM tag WHERE name = #{name}
    </select>
    <!-- 检查标签名是否存在（排除自身） -->
    <select id="existsNameExcludeSelf" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM tag
        WHERE name = #{name}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

</mapper>